import classNames from 'classnames'
import { debounce, uniqBy } from 'lodash'
import { useAccount } from 'wagmi'

import React, { FC, useCallback, useEffect, useRef, useState } from 'react'
import { useTranslation } from 'react-i18next'
import { useHistory } from 'react-router-dom'

import { searchMarginToken } from '@/api'
import { DropDownList, DropDownListItem } from '@/components/common/DropDownList'
import Image from '@/components/common/Image'
import { useMarginBalances } from '@/hooks/useMarginBalances'
import { resortMargin } from '@/pages/web/MySpace'
import { getMarginDeployStatus, getMarginTokenList, useMarginTokenListStore, useMarginTokenStore } from '@/store'
import { MarginTokenState } from '@/store/types'
import { Rec } from '@/typings'

let seqCount = 0

interface MarginOptions {
  data: Rec[];
  loaded: boolean
}

const MarginToken: FC = () => {
  const history = useHistory()
  const bottomRef = useRef<any>()
  const observerRef = useRef<IntersectionObserver | null>()
  const { t } = useTranslation()
  const { address } = useAccount()
  const marginToken = useMarginTokenStore((state: MarginTokenState) => state.marginToken)
  const marginTokenList = useMarginTokenListStore((state) => state.marginTokenList)
  const { data: marginBalances } = useMarginBalances(address, marginTokenList, marginToken)
  const [marginOptions, setMarginOptions] = useState<MarginOptions>({ data: [], loaded: false })
  const [searchKeyword, setSearchKeyword] = useState<string>('')

  const _searchMarginToken = useCallback(
    debounce(async (searchKeyword: string) => {
      const { data = [] } = await searchMarginToken(searchKeyword)
      setMarginOptions({ data, loaded: false })
    }, 1500),
    []
  )

  const funcAsync = useCallback(async () => {
    const { records = [] } = await getMarginTokenList(seqCount)
    const deployStatus = await getMarginDeployStatus(records)
    const filter = records.filter((f: Rec) => deployStatus[f.symbol])
    const combine = [...marginOptions.data, ...filter]
    const deduplication = uniqBy(combine, 'margin_token')
    setMarginOptions((val: any) => ({ ...val, data: deduplication, loaded: false }))
    if (records.length === 0 || records.length < 30) seqCount = seqCount - 1
  }, [marginOptions.data])

  useEffect(() => {
    if (searchKeyword.trim()) {
      setMarginOptions({ data: [], loaded: true })
      void _searchMarginToken(searchKeyword)
    } else {
      seqCount = 0
      if (marginTokenList.length && marginBalances) {
        const _ = marginTokenList.map((margin) => {
          const marginBalance = marginBalances?.[margin.symbol] ?? 0
          return { ...margin, marginBalance: Number(marginBalance) }
        })
        setMarginOptions({ data: resortMargin(_), loaded: false })
      }
    }
  }, [searchKeyword, marginBalances, marginTokenList])

  useEffect(() => {
    if (marginOptions.data.length) {
      const intersectionObserver = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting && entry.target.id === 'bottom') {
              seqCount += 1
              console.info('intersectionObserver=', seqCount)
              void funcAsync()
            }
          })
        },
        { threshold: 0.2 }
      )
      if (bottomRef.current) {
        intersectionObserver.observe(bottomRef.current)
        observerRef.current = intersectionObserver
      }
    }
    return () => {
      observerRef.current && observerRef.current.disconnect()
    }
  }, [marginOptions.data.length])

  return (
    <DropDownList
      entry={
        <div className='web-trade-bench-margin-token'>
          <label>{t('Trade.Bench.Margin')}</label>
          <section>
            <Image src={marginToken.logo} />
            <strong>{marginToken.symbol}</strong>
          </section>
        </div>
      }
      loading={marginOptions.loaded}
      onSearch={setSearchKeyword}
      placeholder={t('Trade.Bench.SearchTip')}
    >
      {marginOptions.data.map((o: Rec, index: number) => {
        const len = marginOptions.data.length
        const id = index === len - 1 ? 'bottom' : undefined
        const ref = index === len - 1 ? bottomRef : null
        const _id = searchKeyword.trim() ? undefined : id
        const _ref = searchKeyword.trim() ? null : ref
        return (
          <DropDownListItem
            key={o.margin_token}
            id={_id}
            ref={_ref}
            content={
              <>
                <Image src={o.logo} style={{ width: '24px' }} />
                {o.symbol}
              </>
            }
            onSelect={() => history.push(`/${o.symbol}/trade`)}
            className={classNames('web-trade-bench-margin-item', { close: !o.open })}
          />
        )
      })}
    </DropDownList>
  )
}

export default MarginToken
